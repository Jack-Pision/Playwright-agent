# ğŸš€ Playwright Agent v3.0 - Deployment Guide (Supabase Edition)

This guide provides all the steps to deploy the Playwright Agent to Render and connect it to your Supabase backend for persistent, secure credential storage.

### ğŸ—ï¸ **Architecture Overview**

```
User â†’ AI Chatbot â†’ Playwright Agent (Render) â†’ Supabase (Credentials) â†’ Document Platforms
```

### âœ¨ **Key Features**

- **ğŸ” Supabase Integration**: Securely stores user credentials (cookies, local storage) in your Supabase database.
- **ğŸ‘¤ User-Specific Sessions**: Each automation runs with the specific user's saved credentials.
- **â˜ï¸ Cloud-Native**: Designed to run headlessly on serverless platforms like Render.
- **ğŸ¤– One-Time Login Flow**: The agent tells your chatbot when a user needs to authenticate, enabling a seamless one-time setup.

---

## ğŸ“‹ **Deployment & Setup Steps**

### **Step 1: Create a Supabase Table**

In your Supabase project, go to the **SQL Editor** and run the following script to create the `playwright_auth_credentials` table.

```sql
-- Create a table to store user authentication states for different platforms
CREATE TABLE public.playwright_auth_credentials (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id TEXT NOT NULL, -- The unique ID of the user from your chatbot
  platform TEXT NOT NULL, -- 'google', 'notion', etc.
  auth_state JSONB NOT NULL, -- The encrypted Playwright storageState JSON
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(user_id, platform) -- Ensures one set of credentials per user per platform
);

-- Recommended: Enable Row Level Security
ALTER TABLE public.playwright_auth_credentials ENABLE ROW LEVEL SECURITY;

-- Create a policy to allow your agent to access the data using its service key
CREATE POLICY "Allow service role access"
ON public.playwright_auth_credentials
FOR ALL
USING (TRUE)
WITH CHECK (TRUE);
```

### **Step 2: Deploy to Render**

1.  Push this updated codebase to your GitHub repository.
2.  In the Render Dashboard, create a new **Web Service**.
3.  Connect your GitHub repository.
4.  Set the following configuration:
    - **Build Command**: `npm install && npx playwright install --with-deps chromium`
    - **Start Command**: `npm start`

### **Step 3: Configure Environment Variables**

In your Render service settings, go to the **Environment** tab and add the following secrets:

-   `SUPABASE_URL`: Your Supabase project URL.
-   `SUPABASE_SERVICE_ROLE_KEY`: Your Supabase project `service_role` secret key.
-   `NODE_ENV`: `production`

---

## ğŸ¤– **New API & Login Flow**

The authentication flow is now managed between your chatbot and the agent.

### **How the Login Works**

1.  **Request from Chatbot**: Your app sends a request to `/edit-doc` including a `userId`.
    ```json
    {
      "userId": "user_from_your_app_123",
      "docUrl": "https://docs.google.com/document/...",
      "instruction": "Add a new heading titled 'Project Goals'"
    }
    ```
2.  **Agent Checks Auth**: The agent queries your Supabase table for credentials matching `userId` and the document's platform (e.g., 'google').
3.  **Login Needed Response**: If no credentials are found, the agent responds with a `401 Unauthorized` error, telling your chatbot to initiate a login.
    ```json
    // Response from Agent if login is needed
    {
      "error": "Authentication required for Google Docs.",
      "platform": "google"
    }
    ```
4.  **Chatbot Guides User**: Your chatbot must now guide the user to log in. This involves:
    -   Opening a temporary Playwright browser **locally or in a separate cloud function** to let the user log into the required service (e.g., Google).
    -   After login, extracting the session state using `await context.storageState()`.
5.  **Save Credentials**: Your chatbot then sends the extracted `authState` to the agent's new endpoint.
    ```bash
    POST /save-credentials
    ```
    ```json
    {
      "userId": "user_from_your_app_123",
      "platform": "google",
      "authState": { ... } // The full storageState object from Playwright
    }
    ```
6.  **Automation Runs**: The agent saves the credentials to Supabase. The user is now authenticated, and future `/edit-doc` requests will succeed.

---

## ğŸ” **Testing Your Deployment**

### **1. Health Check**

Check if the agent is running and connected to Supabase.

```bash
curl https://your-agent.onrender.com/health
```
**Expected Response:**
```json
{
  "status": "healthy",
  "version": "3.0.0-supabase",
  "supabase": {
    "connected": true
  }
}
```

### **2. Automation Request**

Make a request to the main endpoint. If the user isn't authenticated, you'll get the `401` error.

```bash
curl -X POST https://your-agent.onrender.com/edit-doc \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test_user_01",
    "docUrl": "https://docs.google.com/document/d/your-doc-id/edit",
    "instruction": "Add a heading from the cloud!"
  }'
```

---

## ğŸ› Troubleshooting

### Common Issues

**âŒ "Authentication not configured"**
- Solution: Add environment variables (GOOGLE_EMAIL, GOOGLE_PASSWORD, etc.)

**âŒ "Could not detect document platform"**
- Solution: Ensure URL format is correct or provide more context

**âŒ "Browser crashed" / "Timeout"**
- Solution: This is normal for cloud - the system will retry automatically

### Debug Mode

Set environment variable `DEBUG=true` for verbose logging:
```env
DEBUG=true
```

---

## ğŸ“Š Performance & Limits

### Render Free Tier
- âœ… **Sleeps after 15 minutes** of inactivity (normal)
- âœ… **750 hours/month** usage limit
- âœ… **Perfect for AI chatbot** integration

### Response Times
- **First request** (cold start): ~10-15 seconds
- **Subsequent requests**: ~3-5 seconds
- **File detection**: ~500ms

### Scaling
For high-volume usage, upgrade to Render's paid plans for:
- No sleep mode
- Faster performance
- More concurrent users

---

## ğŸ” Security Best Practices

1. **Use app passwords**, not main account passwords
2. **Rotate credentials** regularly
3. **Monitor usage** through Render dashboard
4. **Limit document access** to specific accounts
5. **Use HTTPS** for all API calls

---

## ğŸ¯ What Your AI Chatbot Can Now Do

### Smart Capabilities

- **ğŸ“„ Google Docs**: Add text, headings, format content, find & replace
- **ğŸ“Š Google Slides**: Create slides, add content, change themes
- **ğŸ“‘ Google Sheets**: Edit cells, add formulas (coming soon)
- **ğŸ“ Notion**: Create blocks, lists, headings, databases
- **ğŸ“ Microsoft Office**: Basic editing (via cloud interfaces)

### Example User Interactions

```
User: "Add a summary to my project doc"
AI: *detects Google Docs, enhances query*
Agent: *adds professional summary section*

User: "Make my presentation more engaging"  
AI: *detects Google Slides, suggests improvements*
Agent: *adds animations, updates theme*

User: "Create meeting notes in Notion"
AI: *detects Notion, structures content*
Agent: *creates formatted meeting notes template*
```

---

## ğŸš€ Your API Key Setup

Once deployed on Render, your API key for the AI chatbot is:
```
PLAYWRIGHT_AGENT_URL=https://your-app-name.onrender.com
```

**Perfect! Your cloud-powered document automation agent is ready!** ğŸ‰ 